
/*  $Id: INILetter.java,v 1.1 2005/04/05 21:34:47 tbayen Exp $

    This file is part of HBCI4Java
    Copyright (C) 2001-2004  Stefan Palme

    HBCI4Java is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 2 of the License, or
    (at your option) any later version.

    HBCI4Java is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program; if not, write to the Free Software
    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
*/

package org.kapott.hbci.passport;

import java.io.PrintWriter;
import java.io.StringWriter;
import java.math.BigInteger;
import java.security.MessageDigest;
import java.security.interfaces.RSAPublicKey;
import java.util.Date;

import org.kapott.hbci.exceptions.HBCI_Exception;
import org.kapott.hbci.manager.HBCIKey;
import org.kapott.hbci.manager.HBCIUtils;

/** Hilfsklasse für das Erzeugen von INI-Briefen (für RDH-Zugänge). Diese Klasse
    ermöglicht das Erzeugen von INI-Briefen. Dazu werden Methoden bereitgestellt,
    mit deren Hilfe die für einen INI-Brief benötigten Daten ermittelt werden
    können. Außerdem liefert die {@link #toString()}-Methode einen vorgefertigten
    INI-Brief (kann als Vorlage benutzt werden). */
public class INILetter
{
    /** INI-Brief für Institutsschlüssel (wird für Vergleich mit tatsächlichem
        INI-Brief von der Bank benötigt) */
    public static final int TYPE_INST=1;
    /** INI-Brief für Nutzerschlüssel erzeugen (muss nach dem Erstellen neuer
        Schlüssel an die Bank versandt werden) */
    public static final int TYPE_USER=2;
    
    private HBCIPassport passport;
    private HBCIKey      hbcikey;
    
    /** Anlegen eines neuen INI-Brief-Objektes.
        @param passport das Passport-Objekt (entspricht einem HBCI-Zugang), für
               den ein INI-Brief benötigt wird
        @param type gibt an, für welche Schlüssel aus dem <code>passport</code> 
               der INI-Brief benötigt wird ({@link #TYPE_INST} für die Bankschlüssel,
               {@link #TYPE_USER} für die Schlüssel des Nutzers) */
    public INILetter(HBCIPassport passport,int type)
    {
        this.passport=passport;
        
        if (type==TYPE_INST) {
            hbcikey=passport.getInstSigKey();
            if (hbcikey==null)
                hbcikey=passport.getInstEncKey();
        } else {
            hbcikey=passport.getMyPublicSigKey();
        }
    }
    
    private byte[] getKeyData(BigInteger x)
    {
        byte[] xArray=x.toByteArray();
        byte[] retArray=new byte[128];
        System.arraycopy(xArray,xArray.length-Math.min(128,xArray.length),
                         retArray,128-Math.min(128,xArray.length),
                         Math.min(128,xArray.length));
        return retArray;
    }
    
    /** Gibt den Exponenten des öffentlichen Schlüssels zurück. Das byte-Array hat
        dabei immer eine Größe von 128 Bytes (also mit führenden Nullen aufgefüllt).
        @return Exponent des öffentlichen Schlüssels */
    public byte[] getKeyExponent()
    {
        return getKeyData(((RSAPublicKey)hbcikey.key).getPublicExponent());
    }
    
    /** Gibt den Modulus des öffentlichen Schlüssels zurück. Das byte-Array hat
        dabei immer eine Größe von 128 Bytes (also mit führenden Nullen aufgefüllt).
        @return Modulus des öffentlichen Schlüssels */
    public byte[] getKeyModulus()
    {
        return getKeyData(((RSAPublicKey)hbcikey.key).getModulus());
    }
    
    /** Gibt den Hashwert des öffentlichen Schlüssels zurück. Das byte-Array hat
        dabei immer eine Größe von 20 Bytes.
        @return Hashwert des öffentlichen Schlüssels */
    public byte[] getKeyHash()
    {
        try {
            byte[] retArray=new byte[256];
            System.arraycopy(getKeyExponent(),0,retArray,0,128);
            System.arraycopy(getKeyModulus(),0,retArray,128,128);
            
            MessageDigest dig=MessageDigest.getInstance("RIPEMD160","HBCIProvider");
            return dig.digest(retArray);
        } catch (Exception e) {
            throw new HBCI_Exception("*** error while calculating hash value",e);
        }
    }
    
    /** Gibt einen "fertigen" INI-Brief zurück.
        @return INI-Brief */
    public String toString()
    {
        StringWriter ret=new StringWriter();
        PrintWriter out=new PrintWriter(ret);
        
        Date date=new Date();
        
        out.println();
        out.println("INI-Brief HBCI");
        out.println();
        out.println();
        out.println("Datum:                       "+HBCIUtils.date2String(date));
        out.println();
        out.println("Uhrzeit:                     "+HBCIUtils.time2String(date));
        out.println();
        out.println("Empfänger BLZ:               "+passport.getBLZ());
        out.println();
        out.println("Benutzerkennung:             "+passport.getUserId());
        out.println();
        out.println("Schlüsselnummer:             "+hbcikey.num);
        out.println();
        out.println("Schlüsselversion:            "+hbcikey.version);
        out.println();
        out.println("HBCI-Version:                "+passport.getHBCIVersion());
        out.println();
        out.println();
        out.println("Öffentlicher Schlüssel für die elektronische Signatur");
        out.println();
        out.println("  Exponent");
        out.println();
        String st=HBCIUtils.data2hex(getKeyExponent());
        for (int line=0;line<8;line++) {
            out.println("    "+st.substring(line*(16*3),(line+1)*16*3));
        }
        
        out.println();
        out.println("  Modulus");
        out.println();
        st=HBCIUtils.data2hex(getKeyModulus());
        for (int line=0;line<8;line++) {
            out.println("    "+st.substring(line*(16*3),(line+1)*16*3));
        }

        out.println();
        out.println("  Hashwert");
        out.println();
        st=HBCIUtils.data2hex(getKeyHash());
        for (int line=0;line<2;line++) {
            out.println("    "+st.substring(line*(10*3),(line+1)*10*3));
        }
        
        out.println();
        out.println("Ich bestätige hiermit den obigen öffentlichen Schlüssel");
        out.println("für meine elektronische Signatur");
        out.println();
        out.println();
        out.println();
        out.println();
        out.println();
        out.println();
        out.println();
        out.println("Ort/Datum                                       Unterschrift");
        
        out.close();
        return ret.toString();
    }
}
